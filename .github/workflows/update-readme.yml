name: Auto Update README

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Update README with latest info
      run: |
        echo "ğŸ”„ å¼€å§‹æ›´æ–°é¡¹ç›®æ—¶é—´æˆ³..."
        
        # æ˜¾ç¤ºå½“å‰ç›®å½•å†…å®¹
        echo "ğŸ“‚ å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        
        # é¡¹ç›®æ–‡ä»¶å¤¹åˆ°READMEé¡¹ç›®åç§°çš„æ˜ å°„
        declare -A project_mapping
        project_mapping["fakePow"]="FakePow"
        project_mapping["firstContract"]="SepoliaContract"
        project_mapping["tenderly"]="BuyMeACoffee"
        
        echo "ğŸ—ºï¸ é¡¹ç›®æ˜ å°„:"
        for key in "${!project_mapping[@]}"; do
          echo "  $key -> ${project_mapping[$key]}"
        done
        
        # å¤„ç†æ¯ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹
        for folder in */; do
          folder_name=${folder%/}
          
          echo "ğŸ“ æ£€æŸ¥æ–‡ä»¶å¤¹: $folder_name"
          
          # è·³è¿‡éé¡¹ç›®æ–‡ä»¶å¤¹
          if [[ "$folder_name" == "TestFolder" || "$folder_name" == ".git" || "$folder_name" == ".github" ]]; then
            echo "â­ï¸ è·³è¿‡æ–‡ä»¶å¤¹: $folder_name"
            continue
          fi
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ˜ å°„
          if [[ -z "${project_mapping[$folder_name]:-}" ]]; then
            echo "âš ï¸ æœªæ‰¾åˆ° $folder_name çš„é¡¹ç›®æ˜ å°„ï¼Œè·³è¿‡"
            continue
          fi
          
          project_name="${project_mapping[$folder_name]}"
          echo "ğŸ¯ å¤„ç†é¡¹ç›®: $folder_name -> $project_name"
          
          # è·å–æ–‡ä»¶å¤¹æœ€åæäº¤æ—¶é—´
          echo "ğŸ“Š è·å– $folder_name çš„gitå†å²..."
          last_commit_time=$(git log -1 --format="%ci" -- "$folder_name" 2>/dev/null)
          
          if [[ -n "$last_commit_time" ]]; then
            echo "â° åŸå§‹æäº¤æ—¶é—´: $last_commit_time"
            
            # è½¬æ¢ä¸ºæ‰€éœ€æ ¼å¼ (YYYY-MM-DD)
            formatted_date=$(date -d "$last_commit_time" +"%Y-%m-%d" 2>/dev/null || date -j -f "%Y-%m-%d %H:%M:%S %z" "$last_commit_time" +"%Y-%m-%d" 2>/dev/null)
            
            if [[ -n "$formatted_date" ]]; then
              echo "ğŸ“… $project_name æœ€åæ›´æ–°æ—¶é—´: $formatted_date"
              
              # æ£€æŸ¥é¡¹ç›®çŠ¶æ€
              status="ğŸ”§ å¼€å‘ä¸­"
              echo "ğŸ” æ£€æŸ¥éƒ¨ç½²çŠ¶æ€..."
              if [[ -f "$folder_name/deployment.md" ]]; then
                echo "âœ… æ‰¾åˆ° deployment.md æ–‡ä»¶"
                status="âœ… å·²éƒ¨ç½²"
              elif find "$folder_name" -name "*.sol" -exec grep -l "deployed" {} \; 2>/dev/null | head -1; then
                echo "âœ… åœ¨.solæ–‡ä»¶ä¸­æ‰¾åˆ°éƒ¨ç½²æ ‡è®°"
                status="âœ… å·²éƒ¨ç½²"
              else
                echo "ğŸ”§ æœªæ‰¾åˆ°éƒ¨ç½²æ ‡è®°ï¼Œæ ‡è®°ä¸ºå¼€å‘ä¸­"
              fi
              
              echo "ğŸ“Š $project_name çŠ¶æ€: $status"
              
              # æ›´æ–°READMEä¸­çš„æ—¶é—´æˆ³å’ŒçŠ¶æ€
              echo "ğŸ“ æ›´æ–°README..."
              
              # ä½¿ç”¨æ›´å®‰å…¨çš„sedå‘½ä»¤æ¥æ›´æ–°README
              if grep -q "| $project_name |" README.md; then
                # åˆ›å»ºä¸´æ—¶æ–‡ä»¶è¿›è¡Œå®‰å…¨æ›¿æ¢
                temp_file=$(mktemp)
                
                # ä½¿ç”¨awkè¿›è¡Œç²¾ç¡®çš„è¡Œæ›¿æ¢
                awk -v project="$project_name" -v date="$formatted_date" -v stat="$status" '
                /^\| [^|]+ \| [^|]+ \| [^|]+ \| [^|]+ \|/ {
                  if ($2 ~ project) {
                    gsub(/\| [^|]+ \| [^|]+ \|$/, "| " date " | " stat " |")
                  }
                }
                { print }
                ' README.md > "$temp_file"
                
                mv "$temp_file" README.md
                echo "âœ… å·²æ›´æ–° $project_name çš„ä¿¡æ¯"
              else
                echo "âš ï¸ åœ¨READMEä¸­æœªæ‰¾åˆ°é¡¹ç›® $project_name"
              fi
            else
              echo "âŒ æ— æ³•æ ¼å¼åŒ–æ—¥æœŸ: $last_commit_time"
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ° $folder_name çš„gitå†å²"
          fi
        done
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ”¹åŠ¨
        echo "ğŸ” æ£€æŸ¥READMEæ˜¯å¦æœ‰å˜åŒ–..."
        git diff README.md
        
        if git diff --quiet README.md; then
          echo "â„¹ï¸ README.md æ— éœ€æ›´æ–°"
        else
          echo "âœ… README.md å·²æ›´æ–°"
        fi

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet README.md; then
          echo "â„¹ï¸ No changes to commit"
          exit 0
        fi
        
        echo "ğŸ“ æäº¤å˜åŒ–..."
        git add README.md
        git commit -m "ğŸ¤– Auto-update README timestamps [skip ci]"
        
        echo "ğŸš€ æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
        git push