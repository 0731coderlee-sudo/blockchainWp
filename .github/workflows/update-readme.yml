name: Auto Update README

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Update README with latest info
      run: |
        # ä¸ºæ¯ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹è·å–æœ€åä¿®æ”¹æ—¶é—´å¹¶æ›´æ–°
        echo "ğŸ”„ å¼€å§‹æ›´æ–°é¡¹ç›®æ—¶é—´æˆ³..."
        
        # é¡¹ç›®æ–‡ä»¶å¤¹åˆ°READMEé¡¹ç›®åç§°çš„æ˜ å°„
        declare -A project_mapping
        project_mapping["fakePow"]="FakePow"
        project_mapping["firstContract"]="SepoliaContract"
        
        # è·å–æ‰€æœ‰é¡¹ç›®æ–‡ä»¶å¤¹
        for dir in */; do
          if [[ "$dir" != ".github/" && "$dir" != "node_modules/" ]]; then
            folder_name=$(basename "$dir" "/")
            readme_name=${project_mapping[$folder_name]:-$folder_name}
            
            echo "ğŸ“ å¤„ç†é¡¹ç›®: $folder_name -> $readme_name"
            
            # è·å–è¯¥é¡¹ç›®æ–‡ä»¶å¤¹çš„æœ€åä¿®æ”¹æ—¶é—´
            project_date=$(git log -1 --date=format:'%Y-%m' --pretty=format:'%cd' -- "$dir" 2>/dev/null || date +'%Y-%m')
            echo "  ğŸ“… æœ€åæ›´æ–°æ—¶é—´: $project_date"
            
            # æ£€æŸ¥é¡¹ç›®çŠ¶æ€
            project_status="âœ… å®Œæˆ"
            if [[ -f "$dir/rs.txt" ]]; then
              project_status="âœ… å·²éƒ¨ç½²"
            elif [[ -f "$dir"*.py || -f "$dir"*.sol ]]; then
              project_status="âœ… å®Œæˆ"
            fi
            
            # ä½¿ç”¨READMEä¸­çš„é¡¹ç›®åç§°è¿›è¡ŒåŒ¹é…å’Œæ›´æ–°
            if grep -q "$readme_name" README.md; then
              # æ›´æ–°æ—¶é—´ - ä½¿ç”¨READMEä¸­çš„é¡¹ç›®åç§°è¿›è¡ŒåŒ¹é…
              sed -i "s/\(.*$readme_name.*\) [0-9]\{4\}-[0-9]\{2\} |/\1 $project_date |/" README.md
              echo "  âœ… å·²æ›´æ–° $readme_name çš„æ—¶é—´æˆ³ä¸º $project_date"
            else
              echo "  âš ï¸  åœ¨READMEä¸­æœªæ‰¾åˆ°é¡¹ç›®: $readme_name"
            fi
          fi
        done
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ”¹åŠ¨
        if git diff --quiet README.md; then
          echo "â„¹ï¸  README.md æ— éœ€æ›´æ–°"
          exit 0
        else
          echo "âœ… README.md å·²æ›´æ–°"
          git diff README.md
        fi

    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --staged --quiet || git commit -m "ğŸ¤– Auto-update README timestamps"
        
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}